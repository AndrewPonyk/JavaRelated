spring:
  application:
    name: api-gateway

  profiles:
    active: ${SPRING_PROFILES_ACTIVE:dev}

  cloud:
    gateway:
      routes:
        # Account Service Routes
        - id: account-service
          uri: lb://account-service
          predicates:
            - Path=/api/v1/accounts/**
          filters:
            - name: CircuitBreaker
              args:
                name: accountService
                fallbackUri: forward:/fallback/account
            - name: RequestRateLimiter
              args:
                redis-rate-limiter.replenishRate: 100
                redis-rate-limiter.burstCapacity: 200
            - AddRequestHeader=X-Request-Source, api-gateway

        # Transaction Service Routes
        - id: transaction-service
          uri: lb://transaction-service
          predicates:
            - Path=/api/v1/transactions/**
          filters:
            - name: CircuitBreaker
              args:
                name: transactionService
                fallbackUri: forward:/fallback/transaction
            - name: RequestRateLimiter
              args:
                redis-rate-limiter.replenishRate: 50
                redis-rate-limiter.burstCapacity: 100

        # Loan Service Routes
        - id: loan-service
          uri: lb://loan-service
          predicates:
            - Path=/api/v1/loans/**
          filters:
            - name: CircuitBreaker
              args:
                name: loanService
                fallbackUri: forward:/fallback/loan

        # Loan Applications Routes
        - id: loan-application-service
          uri: lb://loan-service
          predicates:
            - Path=/api/v1/loan-applications/**
          filters:
            - name: CircuitBreaker
              args:
                name: loanService
                fallbackUri: forward:/fallback/loan

        # Fraud Detection Routes (internal only)
        - id: fraud-detection-service
          uri: lb://fraud-detection-service
          predicates:
            - Path=/api/v1/fraud/**
          filters:
            - name: CircuitBreaker
              args:
                name: fraudService

      default-filters:
        - DedupeResponseHeader=Access-Control-Allow-Origin
        - AddResponseHeader=X-Response-Time, ${spring.application.name}

  # Redis for rate limiting
  data:
    redis:
      host: ${REDIS_HOST:localhost}
      port: ${REDIS_PORT:6379}

  # Security
  security:
    oauth2:
      resourceserver:
        jwt:
          issuer-uri: ${OAUTH2_ISSUER_URI:http://localhost:8180/realms/banking}

server:
  port: ${SERVER_PORT:8080}
  compression:
    enabled: true
    mime-types: application/json,application/xml,text/html,text/plain,application/x-ndjson
    min-response-size: 1024

eureka:
  client:
    service-url:
      defaultZone: ${EUREKA_URL:http://localhost:8761/eureka/}

management:
  endpoints:
    web:
      exposure:
        include: health,info,prometheus,metrics,gateway
  endpoint:
    gateway:
      enabled: true
    health:
      show-details: always

resilience4j:
  circuitbreaker:
    instances:
      accountService:
        slidingWindowSize: 10
        failureRateThreshold: 50
        waitDurationInOpenState: 10s
      transactionService:
        slidingWindowSize: 10
        failureRateThreshold: 50
        waitDurationInOpenState: 10s
      loanService:
        slidingWindowSize: 10
        failureRateThreshold: 50
        waitDurationInOpenState: 10s
      fraudService:
        slidingWindowSize: 10
        failureRateThreshold: 50
        waitDurationInOpenState: 5s

logging:
  level:
    org.springframework.cloud.gateway: DEBUG
    com.bank.gateway: DEBUG

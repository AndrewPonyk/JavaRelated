@page "/login"
@inject AuthService AuthService
@inject NavigationManager Navigation

<PageTitle>Login - TeamChat</PageTitle>

<div class="login-page">
    <div class="login-container">
        <h1>TeamChat</h1>
        <p class="tagline">Real-time team communication</p>

        @if (!_showRegister)
        {
            <form @onsubmit="HandleLogin" class="auth-form">
                <h2>Sign In</h2>

                @if (!string.IsNullOrEmpty(_error))
                {
                    <div class="error-message">@_error</div>
                }

                <div class="form-group">
                    <label for="username">Username</label>
                    <input type="text" id="username" @bind="_username" placeholder="Enter username" required />
                </div>

                <div class="form-group">
                    <label for="password">Password</label>
                    <input type="password" id="password" @bind="_password" placeholder="Enter password" required />
                </div>

                <button type="submit" class="btn-primary" disabled="@_isLoading">
                    @if (_isLoading)
                    {
                        <span>Signing in...</span>
                    }
                    else
                    {
                        <span>Sign In</span>
                    }
                </button>

                <p class="switch-form">
                    Don't have an account?
                    <a href="#" @onclick="() => _showRegister = true" @onclick:preventDefault>Register</a>
                </p>
            </form>
        }
        else
        {
            <form @onsubmit="HandleRegister" class="auth-form">
                <h2>Create Account</h2>

                @if (!string.IsNullOrEmpty(_error))
                {
                    <div class="error-message">@_error</div>
                }

                <div class="form-group">
                    <label for="reg-username">Username</label>
                    <input type="text" id="reg-username" @bind="_username" placeholder="Choose a username" required />
                </div>

                <div class="form-group">
                    <label for="email">Email</label>
                    <input type="email" id="email" @bind="_email" placeholder="Enter email" required />
                </div>

                <div class="form-group">
                    <label for="displayName">Display Name (optional)</label>
                    <input type="text" id="displayName" @bind="_displayName" placeholder="Your display name" />
                </div>

                <div class="form-group">
                    <label for="reg-password">Password</label>
                    <input type="password" id="reg-password" @bind="_password" placeholder="Choose a password" required />
                </div>

                <div class="form-group">
                    <label for="confirm-password">Confirm Password</label>
                    <input type="password" id="confirm-password" @bind="_confirmPassword" placeholder="Confirm password" required />
                </div>

                <button type="submit" class="btn-primary" disabled="@_isLoading">
                    @if (_isLoading)
                    {
                        <span>Creating account...</span>
                    }
                    else
                    {
                        <span>Create Account</span>
                    }
                </button>

                <p class="switch-form">
                    Already have an account?
                    <a href="#" @onclick="() => _showRegister = false" @onclick:preventDefault>Sign In</a>
                </p>
            </form>
        }
    </div>
</div>

@code {
    private string _username = "";
    private string _password = "";
    private string _email = "";
    private string _displayName = "";
    private string _confirmPassword = "";
    private string? _error;
    private bool _isLoading;
    private bool _showRegister;

    protected override void OnInitialized()
    {
        // If already authenticated, redirect to home
        if (AuthService.IsAuthenticated)
        {
            Navigation.NavigateTo("/");
        }
    }

    private async Task HandleLogin()
    {
        _error = null;
        _isLoading = true;

        try
        {
            var (success, error) = await AuthService.LoginAsync(_username, _password);

            if (success)
            {
                Navigation.NavigateTo("/");
            }
            else
            {
                _error = error ?? "Login failed";
            }
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task HandleRegister()
    {
        _error = null;

        if (_password != _confirmPassword)
        {
            _error = "Passwords do not match";
            return;
        }

        if (_password.Length < 6)
        {
            _error = "Password must be at least 6 characters";
            return;
        }

        _isLoading = true;

        try
        {
            var (success, error) = await AuthService.RegisterAsync(
                _username,
                _email,
                _password,
                string.IsNullOrWhiteSpace(_displayName) ? null : _displayName);

            if (success)
            {
                Navigation.NavigateTo("/");
            }
            else
            {
                _error = error ?? "Registration failed";
            }
        }
        finally
        {
            _isLoading = false;
        }
    }
}
